# Yandex Map bookmarks to GPX Converter

Эта утилита позволяет конвертировать закладки (bookmarks) Яндекс Карт в GPX файл для последующего открытия в других
программах, например, в офлайн навигаторе Osmand.

## Требования

* **Python 3.x** (рекомендуется Python 3.8 или выше)

## Установка и настройка

### 1. Установка Python (если не установлен)

Если у вас еще не установлен Python, скачайте его с официального
сайта: [python.org](https://www.python.org/downloads/windows/).

Во время установки обязательно отметьте галочку "Add Python to PATH" (Добавить Python в PATH), это упростит работу с ним
из командной строки.

### 2. Загрузка утилиты

Сохраните содержимое проекта на свой ПК, например, в папку `C:\gpx_converter\`.

### 3. Создание виртуального окружения (рекомендуется)

Виртуальное окружение позволяет изолировать зависимости проекта от других проектов Python на вашей системе. Откройте
командную строку (CMD или PowerShell) и выполните следующие команды:

```cmd
cd C:\gpx_converter\
python -m venv venv
venv\Scripts\activate
```

После активации виртуального окружения, перед именем пользователя в командной строке появится `(venv)`, что означает,
что вы находитесь внутри виртуального окружения.

### 4. Установка зависимостей

Утилита требует установки нескольких библиотек. Находясь в виртуальном окружении, выполните:

```cmd
pip install -r requirements.txt
```

### 5. Настройка API ключа Яндекс Геокодера (опционально, но рекомендуется)

Для получения координат и адресов для ссылок типа `ymapsbm1://org?oid=...` утилите требуется API ключ Яндекс Геокодера.
Вы можете получить его на [странице API Яндекс Карт](https://developer.tech.yandex.ru/services/maps/).

**Вариант 1:** Установите API ключ как переменную окружения.

1. Нажмите `Win + R`, введите `sysdm.cpl` и нажмите Enter.
2. Перейдите на вкладку "Дополнительно" (Advanced).
3. Нажмите кнопку "Переменные среды..." (Environment Variables...).
4. В разделе "Пользовательские переменные" (User variables) или "Системные переменные" (System variables) нажмите "
   Создать..." (New...).
5. В поле "Имя переменной" (Variable name) введите `YANDEX_GEOCODER_API_KEY`.
6. В поле "Значение переменной" (Variable value) вставьте ваш API ключ.
7. Нажмите OK на всех открытых окнах.

**Важно:** После установки переменной окружения, вам нужно будет **перезапустить командную строку**, чтобы она увидела
новую переменную.

**Вариант 2:** Передайте ключ напрямую в командной строке при запуске утилиты с помощью
аргумента `--api_key`:

```cmd
python gpx_converter.py <URL> <ПУТЬ_К_ПАПКЕ> --api_key ВАШ_API_КЛЮЧ
```

**Вариант 3:** Создайте в корне проекта файл `.env` и добавьте в него

```
YANDEX_GEOCODER_API_KEY=ВАШ_API_КЛЮЧ
```

## Использование

Запустите утилиту из командной строки, находясь в папке `C:\gpx_converter\` (и активировав виртуальное окружение, если
вы его создавали):

```cmd
python gpx_converter.py <URL_ИСТОЧНИКА_ДАННЫХ> <ПУТЬ_К_ПАПКЕ_ДЛЯ_СОХРАНЕНИЯ> [--api_key ВАШ_API_КЛЮЧ] [--include-revision]
```

* `<URL_ИСТОЧНИКА_ДАННЫХ>`: URL, с которого утилита будет получать данные. Это может быть как веб-страница, так и
  локальный файл (например, `file:///C:/path/to/your/data.html`).
* `<ПУТЬ_К_ПАПКЕ_ДЛЯ_СОХРАНЕНИЯ>`: Полный путь к папке, куда будет сохранен GPX файл. Убедитесь, что эта папка
  существует.
* `--api_key`: Опциональный API ключ для Яндекс Геокодера. Если не указан, будет использована переменная окружения `YANDEX_GEOCODER_API_KEY`.
* `--include-revision`: Опциональный флаг. Если указан, к названию списка закладок и к имени GPX файла будет добавлен суффикс ` rev:<номер ревизии>`. Без флага используется только исходное название.

### Как получить URL веб страницы?

1. Откройте [Яндекс Карты](https://yandex.ru/maps) и авторизуйтесь под тем пользователем, у которого сохранены закладки.
2. Нажмите иконку профиля (верхний правый угол) -> Закладки и мой транспорт.
3. Каждый из списков (если их несколько) конвертируется отдельно. Для этого откройте меню списка (три точки) и нажмите "
   Поделиться".
4. Во всплывшем окне появится нужная URL-ссылка (иногда появляется не сразу и нужно подождать).

### Пример использования

Предположим, у вас есть файл `my_bookmarks.html` в папке `C:\Users\YourUser\Documents\` и вы хотите сохранить GPX файл
в `C:\Users\YourUser\Downloads\GPX_Files\`.

```cmd
cd C:\gpx_converter\
vvenv\Scripts\activate
python gpx_converter.py file:///C:/Users/YourUser/Documents/my_bookmarks.html C:\Users\YourUser\Downloads\GPX_Files\
```

Если API ключ не установлен как переменная окружения, вы можете передать его так:

```cmd
python gpx_converter.py file:///C:/Users/YourUser/Documents/my_bookmarks.html C:\Users\YourUser\Downloads\GPX_Files\ --api_key abcd12345efgh6789ijkl0123456789
```

С флагом `--include-revision` имя файла будет содержать номер ревизии:

```cmd
python gpx_converter.py file:///C:/Users/YourUser/Documents/my_bookmarks.html C:\Users\YourUser\Downloads\GPX_Files\ --include-revision
```

После выполнения, в указанной папке будет создан GPX файл с именем, соответствующим названию списка закладок (
например, `Тестовые_закладки.gpx`). Если использован флаг `--include-revision`, имя файла будет выглядеть как `Тестовые_закладки_rev_123.gpx`.

### Конфигурация стилей точек для OsmAnd

Утилита поддерживает настройку внешнего вида точек в OsmAnd через файл `osmand_config.json`. В этом файле вы можете 
определить группы по названию списка закладок и задать для каждой группы параметры `color`, `icon` и `background`. Если
для списка нет отдельной группы или название группы в Яндекс Картах будет отличаться от названия в конфиге, то будут 
использованы параметры из группы `default`.

Пример содержимого `osmand_config.json`:

```json
{
  "default": {
    "color": "#FFFF00",
    "icon": "special_marker",
    "background": "circle"
  },
  "Мои любимые места": {
    "color": "#00FF00",
    "icon": "ice_hockey",
    "background": "circle"
  },
  "Работа": {
    "color": "#0000FF",
    "icon": "special_building",
    "background": "square"
  }
}
```

Параметры:

- `color`: цвет метки в формате HEX (например, `#FF0000` для красного).
- `icon`: название иконки из набора OsmAnd (https://github.com/osmandapp/OsmAnd-resources/blob/master/poi/poi_categories.json).
- `background`: форма фона (`circle`, `square`, `octagon`).

Как это работает:

Файл должен находиться в той же папке, что и `gpx_converter.py`. При запуске утилита загрузит конфигурацию и добавит в 
GPX‑файл блок `<osmand:points_groups>` внутри метаданных, что позволит OsmAnd автоматически применять заданные стили к 
точкам. 

> **Важно:** автоматическое применение стилей из `gpx` файла работает в Osmand 5 и, возможно 4 версиях, и не работает в 3-й версии.  

## Пакетная обработка нескольких URL

Для автоматической обработки нескольких списков закладок можно использовать скрипт `batch_gpx_converter.py`. Он читает 
URL из текстового файла и последовательно запускает для каждого из них основной конвертер.

### Подготовка

1. Убедитесь, что в `.env` файле (или в переменных окружения) установлены:
   - `YANDEX_GEOCODER_API_KEY` (опционально, но рекомендуется)
   - `OUTPUT_DIR` – путь к папке, куда будут сохраняться все GPX файлы

   Пример `.env`:
   ```
   YANDEX_GEOCODER_API_KEY=ваш_ключ_геокодера
   OUTPUT_DIR=C:\Users\ВашеИмя\Downloads\GPX_Files
   ```

2. Создайте текстовый файл со списком URL (по одному на строку). Например, `urls.txt`:
   ```
   https://yandex.ru/maps/.../list/...
   https://yandex.ru/maps/.../list/...
   file:///C:/path/to/local/bookmarks.html
   ```

### Использование

```bash
python batch_gpx_converter.py urls.txt
```

Скрипт выведет прогресс и результаты обработки каждого URL. Все GPX файлы будут сохранены в папке, указанной в `OUTPUT_DIR`.

### Примечания

- Скрипт работает как в Windows, так и в Linux.
- Основной скрипт `gpx_converter.py` вызывается с теми же аргументами, что и при ручном запуске.
- Если для какого-то URL произошла ошибка, обработка продолжается для следующих URL.
- Строки, начинающиеся с `#`, игнорируются (можно использовать для комментариев).

## Дополнительная информация

* Утилита пытается извлечь JSON-объект, содержащий `bookmarksPublicList`, из ответа URL.
* Утилита имитирует работу браузера для обхода блокировки роботов, но если что-то пошло не так, то URL можно открыть в
  браузере и через DevTools сохранить содержимое в файл.
* Объекты в Яндекс Картах хранятся в виде ссылок. Для ссылок `ymapsbm1://pin?ll=...` координаты извлекаются напрямую.
  Для ссылок `ymapsbm1://org?oid=...` выполняется запрос к Яндекс Геокодеру для получения координат и адреса. Адрес
  будет добавлен в тег `<osmand:address>` в GPX файле.

